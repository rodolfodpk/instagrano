<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Instagrano - Feed</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { font-family: Arial; max-width: 600px; margin: 20px auto; }
        .post { border: 1px solid #ddd; margin: 20px 0; padding: 15px; }
        .post-header { font-weight: bold; margin-bottom: 10px; }
        .post-image { width: 100%; max-width: 500px; }
        .post-actions { margin-top: 10px; }
        button { padding: 5px 10px; margin-right: 10px; }
        .like-btn { background: #e74c3c; color: white; border: none; }
        .comment-btn { background: #3498db; color: white; border: none; }
        .error { color: red; }
        .loading { text-align: center; }
    </style>
</head>
<body>
    <div x-data="feedApp()">
        <h1>Instagrano Feed</h1>
        <button @click="logout">Logout</button>
        
        <!-- Post Creation Form -->
        <div style="border: 1px solid #ddd; padding: 15px; margin: 20px 0;">
            <h3>Create New Post</h3>
            <input x-model="newPost.title" placeholder="Post title" style="width: 100%; padding: 10px; margin: 5px 0;">
            <input x-model="newPost.caption" placeholder="Caption" style="width: 100%; padding: 10px; margin: 5px 0;">
            <select x-model="newPost.mediaType" style="width: 100%; padding: 10px; margin: 5px 0;">
                <option value="image">Image</option>
                <option value="video">Video</option>
            </select>
            <input type="file" x-ref="fileInput" accept="image/*,video/*" style="width: 100%; padding: 10px; margin: 5px 0;">
            <button @click="createPost" style="width: 100%; padding: 10px; background: #28a745; color: white; border: none;">Create Post</button>
        </div>
        
        <div class="loading" x-show="loading">Loading posts...</div>
        <div class="error" x-show="error" x-text="error"></div>
        
        <!-- Page Size Selector -->
        <div style="margin: 20px 0; text-align: center;">
            <label for="pageSize">Posts per page:</label>
            <select id="pageSize" x-model="pageSize" @change="resetFeed" style="margin-left: 10px; padding: 5px;">
                <option value="3">3 posts</option>
                <option value="5">5 posts</option>
                <option value="10">10 posts</option>
                <option value="20">20 posts</option>
                <option value="50">50 posts</option>
            </select>
        </div>

        <div x-show="posts.length > 0">
            <template x-for="post in posts" :key="post.id">
                <div class="post" :data-post-id="post.id">
                <div class="post-header">Post #<span x-text="post.id"></span></div>
                <div x-text="post.title"></div>
                <div x-text="post.caption"></div>
                <img :src="post.media_url" :alt="post.title" class="post-image">
                <div class="post-actions">
                    <button class="like-btn" @click="likePost(post.id)">
                        Like (<span x-text="post.likes_count"></span>)
                    </button>
                    <button class="comment-btn" @click="showCommentForm(post.id)">
                        Comment (<span x-text="post.comments_count"></span>)
                    </button>
                </div>
                <div x-show="commentingPostId === post.id">
                    <input x-model="newComment" placeholder="Add a comment...">
                    <button @click="addComment(post.id)">Post</button>
                </div>
                </div>
            </template>
            
            <!-- Load More Button -->
            <div x-show="hasMore" style="text-align: center; margin: 20px 0;">
                <button @click="loadMore" :disabled="loadingMore" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px;">
                    <span x-show="!loadingMore">Load More Posts</span>
                    <span x-show="loadingMore">Loading...</span>
                </button>
            </div>
            
            <!-- No more posts message -->
            <div x-show="!hasMore && posts.length > 0" style="text-align: center; margin: 20px 0; color: #666;">
                No more posts to load
            </div>
        </div>
    </div>
    
    <script>
    function feedApp() {
        return {
            posts: [],
            loading: true,
            loadingMore: false,
            error: '',
            hasMore: true,
            nextCursor: '',
            pageSize: 5, // Default page size
            commentingPostId: null,
            newComment: '',
            newPost: {
                title: '',
                caption: '',
                mediaType: 'image'
            },
            activeViews: {}, // Track active view sessions (postId -> started_at timestamp)
            observer: null,
            
            async init() {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/';
                    return;
                }
                await this.loadFeed();
                this.setupViewTracking();
                
                // End all active views when page unloads
                window.addEventListener('beforeunload', () => {
                    this.endAllActiveViews();
                });
            },
            
            resetFeed() {
                // Reset pagination state when page size changes
                this.posts = [];
                this.nextCursor = '';
                this.hasMore = true;
                this.loadFeed();
            },
            
            async createPost() {
                try {
                    const token = localStorage.getItem('token');
                    console.log('Using token:', token ? token.substring(0, 20) + '...' : 'No token');
                    const fileInput = this.$refs.fileInput;
                    
                    if (!fileInput.files[0]) {
                        this.error = 'Please select a file';
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('title', this.newPost.title);
                    formData.append('caption', this.newPost.caption);
                    formData.append('media_type', this.newPost.mediaType);
                    formData.append('media', fileInput.files[0]);
                    
                    const response = await fetch('http://localhost:8080/api/posts', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                    console.log('Request headers:', {
                        'Authorization': `Bearer ${token}`
                    });
                    
                    if (response.ok) {
                        this.newPost.title = '';
                        this.newPost.caption = '';
                        this.newPost.mediaType = 'image';
                        fileInput.value = '';
                        // Reset pagination state and reload feed
                        this.posts = [];
                        this.nextCursor = '';
                        this.hasMore = true;
                        await this.loadFeed(); // Reload to show new post
                    } else {
                        const errorData = await response.json();
                        this.error = `Failed to create post: ${errorData.error || 'Unknown error'}`;
                        console.error('Post creation failed:', errorData);
                    }
                } catch (e) {
                    this.error = `Failed to create post: ${e.message}`;
                    console.error('Post creation error:', e);
                }
            },
            
            async loadFeed() {
                try {
                    this.loading = true;
                    const token = localStorage.getItem('token');
                    console.log('LoadFeed token:', token ? token.substring(0, 20) + '...' : 'No token');
                    
                    // Use cursor-based pagination with configurable page size
                    const url = this.nextCursor 
                        ? `http://localhost:8080/api/feed?limit=${this.pageSize}&cursor=${this.nextCursor}`
                        : `http://localhost:8080/api/feed?limit=${this.pageSize}`;
                    
                    const response = await fetch(url, {
                        headers: {'Authorization': `Bearer ${token}`}
                    });
                    
                    console.log('LoadFeed response status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Check if this is cursor-based response
                        if (data.has_more !== undefined) {
                            // Cursor-based pagination
                            this.posts = [...this.posts, ...(data.posts || [])];
                            this.hasMore = data.has_more;
                            this.nextCursor = data.next_cursor || '';
                        } else {
                            // Fallback to page-based pagination
                            this.posts = data.posts || [];
                            this.hasMore = false;
                            this.nextCursor = '';
                        }
                        
                        // Re-observe posts for view tracking
                        this.$nextTick(() => {
                            this.observeNewPosts();
                        });
                    } else {
                        this.error = 'Failed to load feed';
                    }
                } catch (e) {
                    this.error = 'Network error';
                } finally {
                    this.loading = false;
                }
            },
            
            async loadMore() {
                if (!this.hasMore || this.loadingMore) return;
                
                try {
                    this.loadingMore = true;
                    const token = localStorage.getItem('token');
                    
                    const url = `http://localhost:8080/api/feed?limit=${this.pageSize}&cursor=${this.nextCursor}`;
                    const response = await fetch(url, {
                        headers: {'Authorization': `Bearer ${token}`}
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.posts = [...this.posts, ...(data.posts || [])];
                        this.hasMore = data.has_more;
                        this.nextCursor = data.next_cursor || '';
                        
                        // Re-observe new posts for view tracking
                        this.$nextTick(() => {
                            this.observeNewPosts();
                        });
                    } else {
                        this.error = 'Failed to load more posts';
                    }
                } catch (e) {
                    this.error = 'Network error';
                } finally {
                    this.loadingMore = false;
                }
            },
            
            async likePost(postId) {
                try {
                    const token = localStorage.getItem('token');
                        const response = await fetch(`http://localhost:8080/api/posts/${postId}/like`, {
                        method: 'POST',
                        headers: {'Authorization': `Bearer ${token}`}
                    });
                    
                    if (response.ok) {
                        await this.loadFeed(); // Reload to get updated counts
                    }
                } catch (e) {
                    this.error = 'Failed to like post';
                }
            },
            
            showCommentForm(postId) {
                this.commentingPostId = postId;
                this.newComment = '';
            },
            
            async addComment(postId) {
                try {
                    const token = localStorage.getItem('token');
                        const response = await fetch(`http://localhost:8080/api/posts/${postId}/comment`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({text: this.newComment})
                    });
                    
                    if (response.ok) {
                        this.commentingPostId = null;
                        this.newComment = '';
                        await this.loadFeed(); // Reload to get updated counts
                    }
                } catch (e) {
                    this.error = 'Failed to add comment';
                }
            },
            
            observeNewPosts() {
                // Observe new posts that aren't already being observed
                if (this.observer) {
                    document.querySelectorAll('.post:not([data-observed])').forEach(post => {
                        this.observer.observe(post);
                        post.setAttribute('data-observed', 'true');
                    });
                }
            },
            
            setupViewTracking() {
                // Setup Intersection Observer to track when posts enter/exit viewport
                this.observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const postId = parseInt(entry.target.dataset.postId);
                        if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
                            // Post is 50%+ visible - start tracking after 1 second
                            setTimeout(() => {
                                if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
                                    this.startViewTracking(postId);
                                }
                            }, 1000);
                        } else if (!entry.isIntersecting) {
                            // Post left viewport - end tracking
                            this.endViewTracking(postId);
                        }
                    });
                }, {
                    threshold: [0.5], // Trigger when 50% visible
                    rootMargin: '0px'
                });
                
                // Observe all post elements
                this.$nextTick(() => {
                    this.observeNewPosts();
                });
            },
            
            async startViewTracking(postId) {
                if (this.activeViews[postId]) {
                    return; // Already tracking this post
                }
                
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`http://localhost:8080/api/posts/${postId}/view/start`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const viewData = await response.json();
                        this.activeViews[postId] = viewData.started_at;
                        console.log(`Started tracking view for post ${postId}`);
                    }
                } catch (e) {
                    console.error('Failed to start view tracking:', e);
                }
            },
            
            async endViewTracking(postId) {
                if (!this.activeViews[postId]) {
                    return; // Not tracking this post
                }
                
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`http://localhost:8080/api/posts/${postId}/view/end`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            started_at: this.activeViews[postId]
                        })
                    });
                    
                    if (response.ok) {
                        console.log(`Ended tracking view for post ${postId}`);
                    }
                } catch (e) {
                    console.error('Failed to end view tracking:', e);
                } finally {
                    delete this.activeViews[postId];
                }
            },
            
            async endAllActiveViews() {
                // End all active view sessions (for page unload)
                const promises = Object.keys(this.activeViews).map(postId => 
                    this.endViewTracking(parseInt(postId))
                );
                await Promise.allSettled(promises);
            },
            
            logout() {
                this.endAllActiveViews();
                localStorage.removeItem('token');
                window.location.href = '/';
            }
        }
    }
    </script>
</body>
</html>
