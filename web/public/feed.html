<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Instagrano - Feed</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { font-family: Arial; max-width: 600px; margin: 20px auto; }
        .post { border: 1px solid #ddd; margin: 20px 0; padding: 15px; }
        .post-header { font-weight: bold; margin-bottom: 10px; }
        .post-image { width: 100%; max-width: 500px; }
        .post-actions { margin-top: 10px; }
        button { padding: 5px 10px; margin-right: 10px; }
        .like-btn { background: #e74c3c; color: white; border: none; }
        .comment-btn { background: #3498db; color: white; border: none; }
        .error { color: red; }
        .loading { text-align: center; }
    </style>
</head>
<body>
    <div x-data="feedApp()">
        <h1>Instagrano Feed</h1>
        <button @click="logout">Logout</button>
        
        <!-- Post Creation Form -->
        <div style="border: 1px solid #ddd; padding: 15px; margin: 20px 0;">
            <h3>Create New Post</h3>
            <input x-model="newPost.title" placeholder="Post title" style="width: 100%; padding: 10px; margin: 5px 0;">
            <input x-model="newPost.caption" placeholder="Caption" style="width: 100%; padding: 10px; margin: 5px 0;">
            <select x-model="newPost.mediaType" style="width: 100%; padding: 10px; margin: 5px 0;">
                <option value="image">Image</option>
                <option value="video">Video</option>
            </select>
            <input type="file" x-ref="fileInput" accept="image/*,video/*" style="width: 100%; padding: 10px; margin: 5px 0;">
            <button @click="createPost" style="width: 100%; padding: 10px; background: #28a745; color: white; border: none;">Create Post</button>
        </div>
        
        <div class="loading" x-show="loading">Loading posts...</div>
        <div class="error" x-show="error" x-text="error"></div>
        
        <div x-show="posts.length > 0">
            <template x-for="post in posts" :key="post.id">
                <div class="post">
                <div class="post-header">Post #<span x-text="post.id"></span></div>
                <div x-text="post.title"></div>
                <div x-text="post.caption"></div>
                <img :src="post.media_url" :alt="post.title" class="post-image">
                <div class="post-actions">
                    <button class="like-btn" @click="likePost(post.id)">
                        Like (<span x-text="post.likes_count"></span>)
                    </button>
                    <button class="comment-btn" @click="showCommentForm(post.id)">
                        Comment (<span x-text="post.comments_count"></span>)
                    </button>
                </div>
                <div x-show="commentingPostId === post.id">
                    <input x-model="newComment" placeholder="Add a comment...">
                    <button @click="addComment(post.id)">Post</button>
                </div>
                </div>
            </template>
        </div>
    </div>
    
    <script>
    function feedApp() {
        return {
            posts: [],
            loading: true,
            error: '',
            commentingPostId: null,
            newComment: '',
            newPost: {
                title: '',
                caption: '',
                mediaType: 'image'
            },
            
            async init() {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/';
                    return;
                }
                await this.loadFeed();
            },
            
            async createPost() {
                try {
                    const token = localStorage.getItem('token');
                    console.log('Using token:', token ? token.substring(0, 20) + '...' : 'No token');
                    const fileInput = this.$refs.fileInput;
                    
                    if (!fileInput.files[0]) {
                        this.error = 'Please select a file';
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('title', this.newPost.title);
                    formData.append('caption', this.newPost.caption);
                    formData.append('media_type', this.newPost.mediaType);
                    formData.append('media', fileInput.files[0]);
                    
                    const response = await fetch('http://localhost:3007/api/posts', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                    console.log('Request headers:', {
                        'Authorization': `Bearer ${token}`
                    });
                    
                    if (response.ok) {
                        this.newPost.title = '';
                        this.newPost.caption = '';
                        this.newPost.mediaType = 'image';
                        fileInput.value = '';
                        await this.loadFeed(); // Reload to show new post
                    } else {
                        const errorData = await response.json();
                        this.error = `Failed to create post: ${errorData.error || 'Unknown error'}`;
                        console.error('Post creation failed:', errorData);
                    }
                } catch (e) {
                    this.error = `Failed to create post: ${e.message}`;
                    console.error('Post creation error:', e);
                }
            },
            
            async loadFeed() {
                try {
                    this.loading = true;
                    const token = localStorage.getItem('token');
                    console.log('LoadFeed token:', token ? token.substring(0, 20) + '...' : 'No token');
                    
                    const response = await fetch('http://localhost:3007/api/feed', {
                        headers: {'Authorization': `Bearer ${token}`}
                    });
                    
                    console.log('LoadFeed response status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.posts = data.posts || [];
                    } else {
                        this.error = 'Failed to load feed';
                    }
                } catch (e) {
                    this.error = 'Network error';
                } finally {
                    this.loading = false;
                }
            },
            
            async likePost(postId) {
                try {
                    const token = localStorage.getItem('token');
                        const response = await fetch(`http://localhost:3007/api/posts/${postId}/like`, {
                        method: 'POST',
                        headers: {'Authorization': `Bearer ${token}`}
                    });
                    
                    if (response.ok) {
                        await this.loadFeed(); // Reload to get updated counts
                    }
                } catch (e) {
                    this.error = 'Failed to like post';
                }
            },
            
            showCommentForm(postId) {
                this.commentingPostId = postId;
                this.newComment = '';
            },
            
            async addComment(postId) {
                try {
                    const token = localStorage.getItem('token');
                        const response = await fetch(`http://localhost:3007/api/posts/${postId}/comment`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({text: this.newComment})
                    });
                    
                    if (response.ok) {
                        this.commentingPostId = null;
                        this.newComment = '';
                        await this.loadFeed(); // Reload to get updated counts
                    }
                } catch (e) {
                    this.error = 'Failed to add comment';
                }
            },
            
            logout() {
                localStorage.removeItem('token');
                window.location.href = '/';
            }
        }
    }
    </script>
</body>
</html>
